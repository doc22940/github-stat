<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Github activity analysis">
    <meta name="author" content="Alexandr Musikhin">

    <title>GitHub Stat</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css" crossorigin="anonymous">

    <link rel="icon" href="https://github.githubassets.com/favicon.ico" type="image/x-icon">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="GitHub Stat">
    <meta name="twitter:description" content="Github activity analysis">
    <meta name="twitter:image" content="//placehold.it/150">
    <meta property="og:site_name" content="GitHub Stat">
    <meta property="og:title" content="Home">
    <meta property="og:description" content="Github activity analysis">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github-stat.tophackr.com">
    <meta property="og:image" content="//placehold.it/150">
</head>
<body>
    <div class="container-fluid container-md my-4">

        <nav class="navbar navbar-expand navbar-light my-4">

            <a class="navbar-brand" href="/">
                <i class="fab fa-github fa-fw"></i>
                GitHub Stat
            </a>

            <form onsubmit="isClick(); return false;" class="form-inline ml-auto">
                <span class="navbar-text">github.com/</span>
                <input id="search_first" class="form-control mx-2" type="text" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-primary" type="button" onclick="isClick;">Search</button>
            </form>

        </nav>

        <div id="loading" class="row align-items-center h-50">
            <div class="col-md-12 text-center">
                <i class="fas fa-circle-notch fa-fw fa-3x fa-spin text-primary"></i>
            </div>
        </div><!-- /#loading -->

        <div id="main" class="row justify-content-center align-items-center h-75 d-none">
            <div class="col-md-8 text-center">

                <div class="display-4 mb-4">
                    <i class="fab fa-github fa-fw"></i>
                    GitHub Stat
                </div>

                <form onsubmit="isClick(); return false;" class="form-group row">
                    <span class="col-form-label">github.com/</span>
                    <div class="col mx-2">
                        <input id="search_second" class="form-control" type="text" placeholder="Search" aria-label="Search">
                    </div>
                    <button class="btn btn-outline-primary" type="button" onclick="isClick;">Search</button>
                </form>

                <div class="fixed-bottom my-5">
                    <i class="fas fa-code-branch fa-fw"></i>
                    Code on <a href="https://github.com/tophackr/github-stat">tophackr/github-stat</a>
                </div>

            </div>
        </div><!-- /#main -->

        <div id="notfound" class="row align-items-center h-50 d-none">
            <div class="col-md-12 text-center">
                <div class="display-4">Page not found</div>
            </div>
        </div><!-- /#notfound -->

        <div id="profile" class="row d-none">

            <div class="col-md-4 mb-3">
                <div class="card">

                    <div class="card-body">
                        <div class="row">
                            <div class="col-3">
                                <img id="avatar" class="img-fluid rounded" src="/default.png">
                            </div>
                            <div class="col">
                                <a id="name" class="text-body h6 m-0">Not found</a>
                                <a id="blog"></a>
                                <span id="company"></span>
                            </div>
                        </div>
                    </div>

                    <ul id="more" class="list-group list-group-flush">
                        <li class="list-group-item p-0"></li>
                    </ul>

                    <div id="about" class="card-body"></div>

                </div>
            </div><!-- /.col -->

            <div class="col-md-8">
                <div class="card">

                    <div class="card-body">
                        <h5 class="m-0">Latest activities</h5>
                    </div>

                    <ul id="activities" class="list-group list-group-flush">
                        <li class="list-group-item p-0"></li>
                    </ul>

                </div>
            </div><!-- /.col -->

        </div><!-- /#profile -->
    </div><!-- /.container -->

<script>

const home = {
    select: document.querySelector.bind(document),
    selectAll: document.querySelectorAll.bind(document)
};

const username = location.pathname.replace('/', '');

if (username === '') {
    home.select('#loading').classList.add('d-none');
    home.select('#main').classList.remove('d-none');
}

function isClick() {
    if (home.select('#search_second').value !== '') {
        window.location = `/${home.select('#search_second').value}`;
    } else {
        window.location = `/${home.select('#search_first').value}`;
    }
}

(async () => {
    home.select('meta[property="og:url"]').content += `/${username}`;
    var user = null;
    if (username !== '') {
        const response_user = await fetch(`https://api.github.com/users/${username}`);
        const response_rep = await fetch(`https://api.github.com/users/${username}/repos?per_page=100`);
        const response_event = await fetch(`https://api.github.com/users/${username}/events/public`);
        const json_user = await response_user.json();
        const json_rep = await response_rep.json();
        const json_event = await response_event.json();

        user = true;
        if (json_user.message === 'Not Found') {
            user = false;
            return false;
        }

        let allStars = 0;
        let allForks = 0;
        let languages = [];
        json_rep.forEach(repo => {
            allStars += repo.stargazers_count;
            allForks += repo.forks_count;
            languages.push(repo.language);
        });

        const gitSearchElement = home.select('#search_first');
        gitSearchElement.value = json_user.login;

        const gitAvatarElement = home.select('#avatar');
        gitAvatarElement.src = json_user.avatar_url;
        home.select('meta[name="twitter:image"]').content = json_user.avatar_url;
        home.select('meta[property="og:image"]').content = json_user.avatar_url;

        const gitNameElement = home.select('#name');
        gitNameElement.href = json_user.html_url;
        if (json_user.name === null) {
            gitNameElement.textContent = json_user.login;
            home.select('title').textContent = `${json_user.login} | GitHub Stat`;
            home.select('meta[name="twitter:title"]').content = json_user.login;
            home.select('meta[property="og:title"]').content = json_user.login;
        } else {
            gitNameElement.textContent = json_user.name;
            home.select('title').textContent = `${json_user.name} | GitHub Stat`;
            home.select('meta[name="twitter:title"]').content = json_user.name;
            home.select('meta[property="og:title"]').content = json_user.name;
        }
        if (json_user.site_admin === true) {
            gitNameElement.classList.remove('text-body');
            gitNameElement.classList.add('text-primary');
        }

        const gitBlogElement = home.select('#blog');
        if (json_user.blog !== '') {
            gitNameElement.innerHTML += '<br>';
            gitBlogElement.href = json_user.blog; // todo: fix for non http url
            gitBlogElement.textContent = `${json_user.blog.replace(/^(http:|https:)?\/*/i,"")}`;
        }

        if (json_user.company !== null) {
            const gitCompanyElement = home.select('#company');
            if (json_user.blog !== '') { gitBlogElement.innerHTML += '<br>'; } else { gitNameElement.innerHTML += '<br>'; }
            gitCompanyElement.className = `badge badge-primary`;
            gitCompanyElement.innerHTML = `<i class="fas fa-users fa-fw mr-2"></i>${json_user.company}`;
        }

        const gitMoreElement = home.select('#more');
        if (json_user.bio !== null) {
            gitMoreElement.innerHTML += `<li class="list-group-item"><small class="text-muted">Bio:</small><p class="m-0">${json_user.bio}</p></li>`;
            home.select('meta[name="description"]').content = json_user.bio;
            home.select('meta[name="twitter:description"]').content = json_user.bio;
            home.select('meta[property="og:description"]').content = json_user.bio;
        }
        gitMoreElement.innerHTML += `<li class="list-group-item d-flex flex-column"><div><div class="float-left text-muted">Followers</div><div class="float-right">${json_user.followers}</div></div><div><div class="float-left text-muted">Following</div><div class="float-right">${json_user.following}</div></div><div><div class="float-left text-muted">Public Repositories</div><div class="float-right">${json_user.public_repos}</div></div><div><div class="float-left text-muted">Public Gists</div><div class="float-right">${json_user.public_gists}</div></div><div><div class="float-left text-muted">Stars Received</div><div class="float-right">${allStars}</div></div><div><div class="float-left text-muted">Forks by users</div><div class="float-right">${allForks}</div></div></li>`;

        let langBadge = [];
        for (let lang of languages.filter(function(elem, index, self){return index == self.indexOf(elem);}).filter(Boolean)) {
            langBadge += `<span class="badge badge-primary">${lang}</span>\n`;
        }
        if (langBadge != '') {
            gitMoreElement.innerHTML += `<li class="list-group-item">${langBadge}</li>`;
        }

        const gitAboutElement = home.select('#about');
        gitAboutElement.innerHTML = `<small class="text-muted">Joined</small><p>${isDate(json_user.created_at)}</p>`;
        if (json_user.location !== null) {
            gitAboutElement.innerHTML += `<small class="text-muted">Location</small><p class="text-primary">${json_user.location}</p>`;
        }
        gitAboutElement.innerHTML += `<p class="text-muted m-0">Last Updated on ${isDate(json_user.updated_at)}</p>`;

        const gitActivitiesElement = home.select('#activities');
        let plusIcon, branchIcon, trashIcon, commentIcon, starIcon;
        plusIcon = `<i class="fas fa-plus-circle fa-fw text-success"></i>`;
        branchIcon = `<i class="fas fa-code-branch fa-fw text-success"></i>`;
        trashIcon = `<i class="fas fa-trash-alt fa-fw text-danger"></i>`;
        commentIcon = `<i class="fas fa-comment-dots fa-fw text-muted"></i>`;
        starIcon = `<i class="fas fa-star fa-fw text-warning"></i>`;
        json_event.forEach(activities => {
            repoURL = `<a href="${isURL(activities.repo.url)}">${activities.repo.name}</a>`;
            switch (activities.type) {
                case "PushEvent":
                    let commit = `commit`;
                    if (activities.payload.size > 1) {
                        commit += "s";
                    }
                    isStr = `${plusIcon} Pushed <a href="https://github.com/${activities.repo.name}/commits/${activities.payload.ref.split('/').pop()}">${activities.payload.size} ${commit}</a> to ${repoURL}`;
                    break;
                case "WatchEvent":
                    isStr = `${starIcon} Starred a repo ${repoURL}`;
                    break;
                case "CreateEvent":
                    if (activities.payload.ref_type === "branch") {
                        isStr = branchIcon;
                    } else {
                        isStr = plusIcon;
                    }
                    isStr += ` Created a ${activities.payload.ref_type} `;
                    if (activities.payload.ref_type === "branch") {
                        isStr += `<a href="${isURL(activities.repo.url)}/tree/${activities.payload.ref}">${activities.payload.ref}</a> in ${repoURL}`;
                    } else {
                        isStr += repoURL;
                    }
                    break;
                case "DeleteEvent":
                    isStr = `${trashIcon} Deleted a ${activities.payload.ref_type} ${activities.payload.ref} from ${repoURL}`;
                    break;
                case "ForkEvent":
                    isStr = `${branchIcon} Forked a repo ${repoURL} to <a href="${activities.payload.forkee.html_url}">${activities.payload.forkee.full_name}</a>"`;
                    break;
                case "PullRequestEvent":
                    if (activities.payload.action === "closed") {
                        isStr = trashIcon;
                    } else {
                        isStr = plusIcon;
                    }
                    isStr += ` ${activities.payload.action.charAt(0).toUpperCase()}${activities.payload.action.slice(1)} a <a href="${activities.payload.pull_request.html_url}">pull request</a> in ${repoURL}`;
                    break;
                case "PullRequestReviewCommentEvent":
                    isStr = `${commentIcon} ${activities.payload.action.charAt(0).toUpperCase()}${activities.payload.action.slice(1)} a <a href="${activities.payload.comment.html_url}">comment</a> on their pull request in ${repoURL}`;
                    break;
                case "IssuesEvent":
                    if (activities.payload.action === "closed") {
                        isStr = trashIcon;
                    } else {
                        isStr = plusIcon;
                    }
                    isStr += ` ${activities.payload.action.charAt(0).toUpperCase()}${activities.payload.action.slice(1)} an <a href="${activities.payload.issue.html_url}">issue</a> in ${repoURL}`;
                    break;
                case "IssueCommentEvent":
                    isStr = `${commentIcon} ${activities.payload.action.charAt(0).toUpperCase()}${activities.payload.action.slice(1)} <a href="${activities.payload.comment.html_url}">a comment</a> on an issue in ${repoURL}`;
                    break;
                default:
                    console.log(activities.type);
                    return false;
                    break;
            }
            gitActivitiesElement.innerHTML += `<li class="list-group-item"><div class="row"><div class="col-md-9">${isStr}</div><div class="col-md-3 text-muted text-right">${isTimeAgo(activities.created_at)}</div></div></li>`;
        });
    }

    if (user === true) {
        home.select('#loading').classList.add('d-none');
        home.select('#profile').classList.remove('d-none');
    } else if (user === false) {
        home.select('#loading').classList.add('d-none');
        home.select('#notfound').classList.remove('d-none');
    }

    function isDate(d) {
      return new Date(d).toDateString(['en'], {
        month: "long",
        day: "numeric",
        year: "numeric"
      });
    }
    function isURL(u) {
      return u.replace("api", "www").replace("/repos", "");
    }
    function isTimeAgo(t) {
        let current = new Date();
        let previous = new Date(t);
        var msPerMinute = 60 * 1000;
        var msPerHour = msPerMinute * 60;
        var msPerDay = msPerHour * 24;
        var msPerMonth = msPerDay * 30;
        var elapsed = current - previous;
        if (elapsed < msPerMinute) {
            return Math.round(elapsed / 1000) + " seconds ago";
        } else if (elapsed < msPerHour) {
            return Math.round(elapsed / msPerMinute) + " minutes ago";
        } else if (elapsed < msPerDay) {
            return Math.round(elapsed / msPerHour) + " hours ago";
        } else if (elapsed < msPerMonth && Math.round(elapsed / msPerDay) <= 2) {
            return Math.round(elapsed / msPerDay) + " days ago";
        } else {
            return previous.toLocaleDateString(['en'], {
                month: "long",
                day: "numeric"
            });
        }
    }
})();
</script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
</body>
</html>